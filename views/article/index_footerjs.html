<!-- treetable插件 -->
<script src="/static/plugins/jquery-treetable/js/jquery.treetable.js"></script>
<!-- x-editable插件 -->
<script src="/static/plugins/x-editable/js/bootstrap-editable.min.js"></script>
<script type="text/javascript" src="/static/plugins/easymde/easymde.min.js"></script>
<script src="https://cdn.jsdelivr.net/highlight.js/latest/highlight.min.js"></script>
<script>

    /**
     * 加载编辑器
     */
    var easyMDE = new EasyMDE({
        element: document.getElementById("editorarea"),
        autoDownloadFontAwesome: false,
        autofocus: true,
        autosave: {
            enabled: true,
            uniqueId: "editor-temp-0",
            delay: 10000
        },
        renderingConfig: {
            codeSyntaxHighlighting: true
        },
        /*previewRender: function(plainText) {
            var preview = document.getElementsByClassName("editor-preview-side")[0];
            preview.innerHTML = this.parent.markdown(plainText);
            preview.setAttribute('id','editor-preview');
            MathJax.Hub.Queue(["Typeset",MathJax.Hub,"editor-preview"]);
            return preview.innerHTML;
        },*/
        //showIcons: ["code", "table"],
        //status: ["autosave", "lines", "words"],
        //tabSize: 4
    });
    /**
     * 方法来自https://gitee.com/supperzh/zb-blog/blob/master/src/main/resources/templates/article/publish.html#L255
     */
    $(function () {
        inlineAttachment.editors.codemirror4.attach(easyMDE.codemirror, {
            progressText: "![上传中...]()",
            uploadUrl: "/admin/attachments/upload"
        });
    });
    var tagList = $('#tagList');
    /**
     * 初始化标签
     */
    tagList.tagEditor({
        delimiter: ',',
        placeholder: '<@spring.message code="admin.posts.edit.form.tag.placeholder" />',
        forceLowercase: false
    });
    /**
     * 加载该文章已有的标签
     */
/*    <#if post.tags?size gt 0>
    <#list post.tags as tag>
    tagList.tagEditor('addTag','${tag.tagName}');
    </#list>
    </#if>*/

    $('#chooseTag').change(function () {
        tagList.tagEditor('addTag',$(this).val());
    });

    /**
     * 自动填充路径，并且将汉字转化成拼音以-隔开
     */
    function autoComplateUrl() {
        var titleVal = $("#postTitle");
        var postUrl = $("#postUrl");
        if(titleVal.val()!=="" && titleVal.val() !== null && postUrl.html()===''){
            postUrl.html(new Date().getTime());
        }
    }

    /**
     * 检测是否已经存在该链接
     * @constructor
     */
    function urlOnBlurAuto() {
        var newPostUrl = $('#newPostUrl');
        if(newPostUrl.val()===""){
            halo.showMsg("<@spring.message code='admin.editor.js.no-url' />",'info',2000);
            return;
        }
        $.get('/admin/posts/checkUrl',{'postUrl': newPostUrl.val()},function (data) {
            if(data.code===0){
                halo.showMsg(data.msg,'error',2000);
                return;
            }else{
                $('#postUrl').html(newPostUrl.val());
                $('#btn_change_postUrl').hide();
                $('#btn_input_postUrl').show();
            }
        },'JSON');
    }
    $('#btn_input_postUrl').click(function () {
        var postUrl = $("#postUrl");
        postUrl.html("<input type='text' id='newPostUrl' onblur='urlOnBlurAuto()' value='"+postUrl.html()+"'>");
        $(this).hide();
        $('#btn_change_postUrl').show();
    });

    /**
     * 提交文章
     * @param status 文章状态
     */
    function push(status) {
        var postTitle = $("#postTitle");
        var postUrl = $("#postUrl");
        var cateList = new Array();
        if(!postTitle.val()){
            halo.showMsg("<@spring.message code='admin.editor.js.no-title' />",'info',2000);
            return;
        }
        if(!postUrl.html()){
            halo.showMsg("<@spring.message code='admin.editor.js.no-url' />",'info',2000);
            return;
        }
        $('input[name="categories"]:checked').each(function(){
            cateList.push($(this).val());
        });
        $.post('/admin/posts/update',{
            'postId': $('#postId').val(),
            'postStatus': status,
            'postTitle': postTitle.val(),
            'postUrl' : postUrl.html().toString(),
            'postContentMd': easyMDE.value(),
            'postThumbnail': $('#selectImg').attr('src'),
            'cateList' : cateList.toString(),
            'tagList' : $('#tagList').tagEditor('getTags')[0].tags.toString(),
            'allowComment' : $('#allowComment').val(),
            'postDate' : $("#postDate").val(),
            'postPassword' : $("#postPassword").val()
        },function (data) {
            if(data.code === 1){
                //清除自动保存的内容
                easyMDE.toTextArea();
                easyMDE = null;
                halo.showMsgAndRedirect(data.msg,'success',1000,'/admin/posts',"${options.admin_pjax!'true'}");
            }else{
                halo.showMsg(data.msg,'error',2000);
            }
        },'JSON')
    }

    function removeThumbnail(){
        $("#selectImg").attr("src","/static/upload/thumbnail/thumbnail.png");
    }

</script>